<!doctype html>
<html lang="ar"> 
 <head> 
  <meta charset="UTF-8"> 
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
  <title>HOMOS Wallet </title> 
  <link rel="stylesheet" href="style.css"> 
 <style type="text/css" id="dcoder_stylesheet">/* Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª */
body {
  font-family: Arial, sans-serif;
  background-color: #000000; /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡ */
  color: #ffffff; /* Ù†Øµ Ø£Ø¨ÙŠØ¶ */
  padding: 20px;
}

/* Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© */
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background-color: #006400; /* Ø£Ø®Ø¶Ø± ØºØ§Ù…Ù‚ */
  padding: 10px 20px;
  color: white;
  border-radius: 10px;
}

h1 {
  margin: 0;
}

/* Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
input, button {
  margin: 10px 0;
  padding: 12px;
  width: 100%;
  max-width: 350px;
  display: block;
  font-size: 16px;
  border-radius: 8px;
}

input {
  background-color: #1c1c1c; /* Ø®Ù„ÙÙŠØ© Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚ */
  color: white;
  border: 1px solid #2e8b57; /* Ø£Ø®Ø¶Ø± ÙØ§ØªØ­ */
}

/* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
button {
  background-color: #2e8b57; /* Ø£Ø®Ø¶Ø± */
  color: white;
  border: none;
  cursor: pointer;
  transition: 0.3s;
}

button:hover {
  background-color: #3cb371; /* Ø£Ø®Ø¶Ø± Ø£ÙØªØ­ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø±ÙˆØ± */
}

/* Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù‡Ø§Ù…Ø© */
h2, h3 {
  color: #00ff00; /* Ø£Ø®Ø¶Ø± ÙÙˆØ³ÙÙˆØ±ÙŠ */
}

/* Ø§Ù„Ø±ÙˆØ§Ø¨Ø· */
a {
  color: #00ff00; /* Ø£Ø®Ø¶Ø± Ù„Ù„Ø±ÙˆØ§Ø¨Ø· */
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

/* Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª */
#operations-buttons button {
  margin: 10px 5px;
  display: inline-block;
  width: auto;
  padding: 10px 20px;
}

#users-list {
  margin-top: 20px;
}

#users-list button {
  margin-top: 5px;
}

/* Ø§Ø®ÙØ§Ø¡ Ø£Ùˆ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
#deposit-section, 
#withdraw-section, 
#transfer-section, 
#support-section {
  margin-top: 20px;
  padding: 15px;
  background-color: #121212; /* Ø±Ù…Ø§Ø¯ÙŠ Ø¯Ø§ÙƒÙ† */
  border-radius: 10px;
}</style></head> 
 <body style="background-color: black; color: white;"> 
  <header> 
   <h1>HOMOS Wallet </h1> <button onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button> 
  </header> 
  <main> <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ --> 
   <div id="auth-section"> 
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2> 
    <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"> 
    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"> <button onclick="login()">Ø¯Ø®ÙˆÙ„</button> 
    <p id="error-message"></p> 
   </div> <!-- Ø§Ù„Ù…Ø­ÙØ¸Ø© --> 
   <div id="wallet-section" style="display: none;"> 
    <h2>Ø£Ù‡Ù„Ø§ Ø¨ÙŠÙƒØŒ <span id="user-email"></span></h2> 
    <p>Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <span id="balance">0</span> Ø¬Ù†ÙŠÙ‡</p> <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª --> 
    <div id="operations-buttons"> <button onclick="showSection('deposit-section')">Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯</button> <button onclick="showSection('withdraw-section')">Ø³Ø­Ø¨ Ø±ØµÙŠØ¯</button> <button onclick="showSection('transfer-section')">ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯</button> <button onclick="showSection('support-section')">Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ / Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø§Øª</button> 
    </div> <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ --> 
    <div id="deposit-section" style="display: none;"> 
     <h3>Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯</h3> 
     <p>Ø­ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù…: <span id="deposit-phone">01014879247</span> <button onclick="copyPhone()">Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…</button> </p> 
     <input type="number" id="deposit-amount" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù„ÙŠ Ø­ÙˆÙ„ØªÙ‡"> 
     <input type="text" id="sender-phone" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ù„ÙŠ Ø­ÙˆÙ„Øª Ù…Ù†Ù‡"> 
     <input type="file" id="deposit-proof" accept="image/*"> <button onclick="confirmDeposit()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹</button> 
    </div> <!-- Ù‚Ø³Ù… Ø§Ù„Ø³Ø­Ø¨ --> 
    <div id="withdraw-section" style="display: none;"> 
     <h3>Ø³Ø­Ø¨ Ø±ØµÙŠØ¯</h3> 
     <input type="text" id="withdraw-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ù„ÙŠ Ù‡ØªØ³Ø­Ø¨ Ø¹Ù„ÙŠÙ‡"> 
     <input type="number" id="withdraw-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ² ØªØ³Ø­Ø¨Ù‡"> <button onclick="confirmWithdraw()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨</button> 
    </div> <!-- Ù‚Ø³Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ --> 
    <div id="transfer-section" style="display: none;"> 
     <h3>ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯</h3> 
     <input type="email" id="transfer-email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ù…Ø³ØªÙ„Ù…"> 
     <input type="number" id="transfer-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ² ØªØ­ÙˆÙ„Ù‡"> <button onclick="confirmTransfer()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„</button> 
    </div> <!-- Ù‚Ø³Ù… Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ --> 
    <div id="support-section" style="display: none;"> 
     <h3>Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ / Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø§Øª</h3> 
     <p>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: <a href="mailto:homoswallet@gmail.com" style="color: lightgreen;">homoswallet@gmail.com</a> </p> 
     <p>ÙˆØ§ØªØ³Ø§Ø¨: <a href="https://wa.me/201012265953" target="_blank" style="color: lightgreen;">+201012265953</a> </p> 
     <p>Ø±Ù‚Ù… Ø£Ø±Ø¶ÙŠ: <a href="tel:+20402403621" style="color: lightgreen;">+20402403621</a> </p> 
     <p>Ø±Ù‚Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„: <a href="tel:+201014879247" style="color: lightgreen;">+201014879247</a> </p> 
    </div> <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± --> 
    <div id="admin-section" style="display: none;"> 
     <h3>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h3> 
     <input type="email" id="target-email" placeholder="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"> 
     <input type="number" id="add-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù„ÙŠ Ù‡ØªØ²ÙˆØ¯Ù‡"> <button onclick="addBalance()">Ø²ÙˆØ¯ Ø§Ù„Ø±ØµÙŠØ¯</button> 
     <h3>ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:</h3> 
     <div id="users-list"></div> 
    </div> 
   </div> 
  </main> <!-- ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ² --> 
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script> 
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script> <!-- Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ --> 
  <script src="app.js"></script> 
 
<script type="text/javascript" id="dcoder_script">// ØªÙ‡ÙŠØ¦Ø© Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCWyQfMmzp41jTYV4GXFViV2wMMTIiP8XU",
  authDomain: "wallet-52a17.firebaseapp.com",
  projectId: "wallet-52a17",
  storageBucket: "wallet-52a17.appspot.com",
  messagingSenderId: "440517088889",
  appId: "1:440517088889:web:a862ab37106851c66066a8",
  measurementId: "G-28Z0S2BGEV"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// --- Ø¹Ø±Ø¶ Ø£Ùˆ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªÙƒØ±Ø± ---
let currentVisibleSection = null;

function showSection(sectionId) {
  if (currentVisibleSection === sectionId) {
    document.getElementById(sectionId).style.display = "none";
    currentVisibleSection = null;
  } else {
    ["deposit-section", "withdraw-section", "transfer-section", "support-section"].forEach(id => {
      document.getElementById(id).style.display = "none";
    });
    document.getElementById(sectionId).style.display = "block";
    currentVisibleSection = sectionId;
  }
}

// --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ø¹ ÙØ­Øµ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ---
function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value.trim();

  if (!email.includes("@") || password.length < 6) {
    alert("Ø§ÙƒØªØ¨ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØµØ­ÙŠØ­ ÙˆÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø£ÙƒØªØ± Ù…Ù† 6 Ø­Ø±ÙˆÙ.");
    return;
  }

  auth.signInWithEmailAndPassword(email, password)
    .then((userCredential) => {
      afterLogin(email);
    })
    .catch((error) => {
      if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-login-credentials') {
        auth.createUserWithEmailAndPassword(email, password)
          .then((userCredential) => {
            alert("Ø§Ù†Øª Ø¹Ù…Ù„Øª/ÙŠ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ ÙØ§ØªÙƒ ÙƒØªÙŠØ± Ø¨Ø³ Ø¹Ø§Ø¯ÙŠ ğŸ‘");
            afterLogin(email);
          })
          .catch((signupError) => {
            document.getElementById("error-message").innerText = "Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨: " + signupError.message;
          });
      } else {
        document.getElementById("error-message").innerText = "Ø®Ø·Ø£: " + error.message;
      }
    });
}

// --- ØªÙ†ÙÙŠØ° Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ---
function afterLogin(email) {
  document.getElementById("auth-section").style.display = "none";
  document.getElementById("wallet-section").style.display = "block";
  document.getElementById("user-email").innerText = email;

  if (email === "ahmedfouad01278837444@gmail.com") {
    document.getElementById("admin-section").style.display = "block";
    loadUsers();
  }

  const userDoc = db.collection("wallets").doc(email);
  userDoc.get().then(doc => {
    if (!doc.exists) {
      userDoc.set({ balance: 0, history: [] });
    } else {
      document.getElementById("balance").innerText = doc.data().balance.toFixed(2);
    }
  });
}

// --- Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© ---
auth.onAuthStateChanged((user) => {
  if (user) {
    afterLogin(user.email);
  } else {
    document.getElementById("auth-section").style.display = "block";
    document.getElementById("wallet-section").style.display = "none";
  }
});

// --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ---
function logout() {
  auth.signOut().then(() => {
    location.reload();
  });
}

// --- Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ---
function copyPhone() {
  navigator.clipboard.writeText("01014879247");
  alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…!");
}

// --- ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ---
function confirmDeposit() {
  const amount = parseFloat(document.getElementById("deposit-amount").value);
  const senderPhone = document.getElementById("sender-phone").value.trim();
  const userEmail = auth.currentUser.email;

  if (!amount || !senderPhone) {
    alert("Ù…Ø­ØªØ§Ø¬ ØªÙƒØªØ¨ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
    return;
  }

  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù‡ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©.")) {
    let message = `Ø¹Ù…Ù„ÙŠØ© Ø¥ÙŠØ¯Ø§Ø¹ Ø¬Ø¯ÙŠØ¯Ø©\nØ§Ù„Ø¨Ø±ÙŠØ¯: ${userEmail}\nÙ…Ø¨Ù„Øº Ø§Ù„ØªØ­ÙˆÙŠÙ„: ${amount} Ø¬Ù†ÙŠÙ‡\nØ±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ù„ÙŠ Ø­ÙˆÙ„Øª Ù…Ù†Ù‡: ${senderPhone}`;
    let whatsappURL = `https://wa.me/201016553764?text=${encodeURIComponent(message)}`;
    window.open(whatsappURL, '_blank');
    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒØŒ Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡Ø§ ÙˆØ§Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ Ù‚Ø±ÙŠØ¨Ø§Ù‹.");
  }
}

// --- ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø³Ø­Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ---
function confirmWithdraw() {
  const withdrawPhone = document.getElementById("withdraw-phone").value.trim();
  const amount = parseFloat(document.getElementById("withdraw-amount").value);
  const userEmail = auth.currentUser.email;

  if (!withdrawPhone || !amount) {
    alert("Ù…Ø­ØªØ§Ø¬ ØªÙƒØªØ¨ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
    return;
  }

  if (amount < 5) {
    alert("Ø£Ù‚Ù„ Ù…Ø¨Ù„Øº Ù„Ù„Ø³Ø­Ø¨ Ù‡Ùˆ 5 Ø¬Ù†ÙŠÙ‡!");
    return;
  }

  const commission = Math.max(amount * 0.015, 3);
  const finalAmount = amount - commission;

  if (confirm(`Ù‡ÙŠØªÙ… Ø®ØµÙ… ${commission.toFixed(2)} Ø¬Ù†ÙŠÙ‡ Ù…Ù† Ø§Ù„Ù…Ø¨Ù„Øº. Ù…ØªØ£ÙƒØ¯ ØªÙƒÙ…Ù„ØŸ`)) {
    const userDoc = db.collection("wallets").doc(userEmail);

    userDoc.get().then(doc => {
      if (doc.exists && doc.data().balance >= amount) {
        userDoc.update({
          balance: firebase.firestore.FieldValue.increment(-amount),
          history: firebase.firestore.FieldValue.arrayUnion({
            type: 'Ø³Ø­Ø¨',
            amount: amount,
            date: new Date().toISOString()
          })
        }).then(() => {
          let message = `Ø·Ù„Ø¨ Ø³Ø­Ø¨ Ø¬Ø¯ÙŠØ¯\nØ§Ù„Ø¨Ø±ÙŠØ¯: ${userEmail}\nÙ…Ø¨Ù„Øº Ø§Ù„Ø³Ø­Ø¨: ${amount} Ø¬Ù†ÙŠÙ‡\nØ±Ù‚Ù… Ø§Ù„Ø³Ø­Ø¨: ${withdrawPhone}\nØ§Ù„Ù…Ø¨Ù„Øº Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…: ${finalAmount.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;
          let whatsappURL = `https://wa.me/201016553764?text=${encodeURIComponent(message)}`;
          window.open(whatsappURL, '_blank');
          alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø³Ø­Ø¨ØŒ Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡.");
          location.reload();
        });
      } else {
        alert("Ù…Ø¹ÙƒØ´ÙŠ ÙÙ„ÙˆØ³!");
      }
    });
  }
}

// --- ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø¹ Ø®ØµÙ… 1 Ø¬Ù†ÙŠÙ‡ ---
function confirmTransfer() {
  const recipientEmail = document.getElementById("transfer-email").value.trim();
  const amount = parseFloat(document.getElementById("transfer-amount").value);
  const senderEmail = auth.currentUser.email;

  if (!recipientEmail || !amount) {
    alert("Ù…Ø­ØªØ§Ø¬ ØªÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ§Ù„Ù…Ø¨Ù„Øº!");
    return;
  }

  const totalDeduct = amount + 1;

  const senderDoc = db.collection("wallets").doc(senderEmail);
  const recipientDoc = db.collection("wallets").doc(recipientEmail);

  senderDoc.get().then(senderSnapshot => {
    if (senderSnapshot.exists && senderSnapshot.data().balance >= totalDeduct) {
      recipientDoc.get().then(recipientSnapshot => {
        if (recipientSnapshot.exists) {
          recipientDoc.update({
            balance: firebase.firestore.FieldValue.increment(amount),
            history: firebase.firestore.FieldValue.arrayUnion({
              type: 'Ø§Ø³ØªÙ„Ø§Ù… ØªØ­ÙˆÙŠÙ„',
              amount: amount,
              from: senderEmail,
              date: new Date().toISOString()
            })
          });
        } else {
          recipientDoc.set({
            balance: amount,
            history: [{
              type: 'Ø§Ø³ØªÙ„Ø§Ù… ØªØ­ÙˆÙŠÙ„',
              amount: amount,
              from: senderEmail,
              date: new Date().toISOString()
            }]
          });
        }

        senderDoc.update({
          balance: firebase.firestore.FieldValue.increment(-totalDeduct),
          history: firebase.firestore.FieldValue.arrayUnion({
            type: 'ØªØ­ÙˆÙŠÙ„',
            amount: amount,
            to: recipientEmail,
            date: new Date().toISOString()
          })
        }).then(() => {
          alert("Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØµÙ„!");
          location.reload();
        });

      });
    } else {
      alert("Ø±ØµÙŠØ¯Ùƒ Ù…Ø´ ÙƒÙØ§ÙŠØ©!");
    }
  });
}

// --- Ø¥Ø¶Ø§ÙØ© Ø±ØµÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ± ---
function addBalance() {
  const email = document.getElementById("target-email").value.trim();
  const amount = parseFloat(document.getElementById("add-amount").value);

  if (!email || !amount) {
    alert("Ù…Ø­ØªØ§Ø¬ ØªÙƒØªØ¨ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆØ§Ù„Ù…Ø¨Ù„Øº!");
    return;
  }

  const userDoc = db.collection("wallets").doc(email);

  userDoc.get().then(doc => {
    if (doc.exists) {
      userDoc.update({
        balance: firebase.firestore.FieldValue.increment(amount),
        history: firebase.firestore.FieldValue.arrayUnion({
          type: 'Ø§Ø¶Ø§ÙØ© Ù…Ø¯ÙŠØ±',
          amount: amount,
          date: new Date().toISOString()
        })
      }).then(() => {
        alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…!");
      });
    } else {
      userDoc.set({
        balance: amount,
        history: [{
          type: 'Ø§Ø¶Ø§ÙØ© Ù…Ø¯ÙŠØ±',
          amount: amount,
          date: new Date().toISOString()
        }]
      }).then(() => {
        alert("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯!");
      });
    }
  });
}

// --- ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©) ---
function loadUsers() {
  const usersList = document.getElementById("users-list");
  usersList.innerHTML = "";

  db.collection("wallets").get().then(snapshot => {
    snapshot.forEach(doc => {
      const user = doc.id;
      const button = document.createElement("button");
      button.innerText = `Ø´ÙˆÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù€ ${user}`;
      button.onclick = () => showUserHistory(user);
      usersList.appendChild(button);
    });
  });
}

// --- Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¹ÙŠÙ† ---
function showUserHistory(userEmail) {
  db.collection("wallets").doc(userEmail).get().then(doc => {
    if (doc.exists) {
      const history = doc.data().history || [];
      let output = `Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ù„Ù€ ${userEmail}:\n\n`;
      history.forEach(record => {
        output += `${record.date} - ${record.type} - Ù…Ø¨Ù„Øº: ${record.amount} Ø¬Ù†ÙŠÙ‡\n`;
        if (record.to) output += `--> Ø¥Ù„Ù‰: ${record.to}\n`;
        if (record.from) output += `--> Ù…Ù†: ${record.from}\n`;
      });
      alert(output);
    }
  });
}</script></body></html>